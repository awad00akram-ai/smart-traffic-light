<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸš¦ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø±Ù‘Ù…Ù‘Ø§Ø² Ø§Ù„Ø°ÙƒÙŠ - HTML/CSS/JS</title>
  <style>
    :root{
      --brand:#1e73be;
      --brandDark:#15508f;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#dc2626;
      --bg:#f3f4f6;
      --card:#ffffff;
      --border:#e5e7eb;
      --text:#0f172a;
      --muted:#64748b;
      --shadow:0 10px 30px rgba(2,6,23,.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(30,115,190,.10), transparent),
                  radial-gradient(900px 500px at 80% 10%, rgba(14,165,233,.10), transparent),
                  var(--bg);
      color:var(--text);
    }
    header{
      padding:22px 16px 10px;
      max-width:1100px;
      margin:0 auto;
    }
    .title{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .title h1{
      margin:0;
      font-size:22px;
      letter-spacing:.2px;
    }
    .subtitle{
      margin:8px 0 0;
      color:var(--muted);
      font-size:14px;
      line-height:1.6;
    }
    main{
      max-width:1100px;
      margin:0 auto;
      padding:12px 16px 28px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-size:13px;
      color:var(--muted);
    }
    .pill strong{color:var(--text)}
    .select{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      font-size:14px;
      outline:none;
    }
    .select:focus{border-color:rgba(30,115,190,.5); box-shadow:0 0 0 4px rgba(30,115,190,.12)}
    .scenario{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap:14px;
      align-items:stretch;
      margin-top:12px;
    }
    @media (max-width: 520px){
      .scenario{grid-template-columns:1fr}
    }
    .light{
      border:1px solid var(--border);
      border-radius:16px;
      background:#0b1220;
      padding:14px;
      display:grid;
      place-items:center;
      min-height:190px;
      position:relative;
      overflow:hidden;
    }
    .light::before{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.08), transparent 55%),
                  radial-gradient(circle at 70% 70%, rgba(255,255,255,.05), transparent 60%);
      transform:rotate(8deg);
    }
    .bulbs{
      position:relative;
      z-index:1;
      display:grid;
      gap:10px;
    }
    .bulb{
      width:64px; height:64px;
      border-radius:50%;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.15);
      box-shadow: inset 0 0 0 6px rgba(0,0,0,.18);
    }
    .bulb.on.red{background: radial-gradient(circle at 30% 30%, #fff, #ff4d4d 35%, #b20000 70%);}
    .bulb.on.yellow{background: radial-gradient(circle at 30% 30%, #fff, #ffe58a 35%, #c58a00 70%);}
    .bulb.on.green{background: radial-gradient(circle at 30% 30%, #fff, #66ff9d 35%, #007a3a 70%);}

    .facts{
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      background:linear-gradient(180deg, rgba(30,115,190,.06), transparent 60%);
    }
    .facts h2{
      margin:0 0 10px;
      font-size:16px;
    }
    .facts ul{
      margin:0;
      padding:0 18px 0 0;
      color:var(--text);
      line-height:1.9;
      font-size:14px;
    }
    .muted{color:var(--muted)}
    .actions{
      margin-top:14px;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    @media (max-width: 520px){
      .actions{grid-template-columns:1fr 1fr}
    }
    button{
      border:none;
      border-radius:14px;
      padding:12px 12px;
      font-size:15px;
      cursor:pointer;
      font-weight:700;
      transition:.12s transform ease, .12s filter ease;
    }
    button:active{transform:translateY(1px)}
    .btnStop{background:rgba(220,38,38,.12); color:var(--bad); border:1px solid rgba(220,38,38,.28)}
    .btnSlow{background:rgba(245,158,11,.14); color:#9a5b00; border:1px solid rgba(245,158,11,.32)}
    .btnGo{background:rgba(22,163,74,.12); color:var(--ok); border:1px solid rgba(22,163,74,.28)}
    .btnTicket{background:rgba(30,115,190,.12); color:var(--brandDark); border:1px solid rgba(30,115,190,.30)}
    .btnSecondary{
      background:#fff;
      border:1px solid var(--border);
      color:var(--text);
      font-weight:700;
      padding:10px 12px;
      border-radius:12px;
    }
    .sidebar h3{margin:0 0 10px; font-size:16px}
    .rules{
      border-top:1px dashed var(--border);
      margin-top:12px;
      padding-top:12px;
      color:var(--muted);
      font-size:13px;
      line-height:1.7;
    }
    .kpis{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .kpi{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background:#fff;
    }
    .kpi .label{color:var(--muted); font-size:12px}
    .kpi .value{font-size:18px; font-weight:800; margin-top:6px}
    .footerRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
      justify-content:space-between;
      align-items:center;
    }
    .hint{
      font-size:13px;
      color:var(--muted);
    }

    /* Modal */
    .modalWrap{
      position:fixed;
      inset:0;
      background:rgba(2,6,23,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:50;
    }
    .modal{
      width:min(560px, 100%);
      background:#fff;
      border-radius:22px;
      border:1px solid var(--border);
      box-shadow:0 20px 60px rgba(2,6,23,.35);
      padding:16px;
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .badge{
      padding:8px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:13px;
    }
    .badge.ok{background:rgba(22,163,74,.12); color:var(--ok); border:1px solid rgba(22,163,74,.28)}
    .badge.bad{background:rgba(220,38,38,.12); color:var(--bad); border:1px solid rgba(220,38,38,.28)}
    .modal p{
      margin:10px 0 0;
      line-height:1.8;
      color:var(--text);
      font-size:14px;
    }
    .modalActions{
      margin-top:14px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
  </style>
</head>
<body>
  <header>
    <div class="title">
        <h1> ×”××›×œ×œ×” ×”××§×“××™×ª ×”×¢×¨×‘×™×ª ×œ×—×™× ×•×š</h1>
        <h2> ×”××©×—×§ × ×‘× ×” ×¢×œ ×™×“×™ ×¡×˜×•×“× ×˜ ××›×¨×× ×¢×•××“</h2>
      <h3>ğŸš¦ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø±Ù‘Ù…Ù‘Ø§Ø² Ø§Ù„Ø°ÙƒÙŠ</h3>
      <span class="pill"><strong id="stageLabel">Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1</strong> <span class="muted">/ 8</span></span>
      <span class="pill">ğŸ”¢ <strong id="roundLabel">Ø§Ù„Ø¬ÙˆÙ„Ø© 1</strong></span>
      <span class="pill">â­ <strong id="scoreLabel">0</strong></span>
    </div>
    <p class="subtitle">
      Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­ Ø­Ø³Ø¨ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ø±Ø­Ù„Ø©. Ù‡Ø°Ù‡ Ø§Ù„Ù„Ø¹Ø¨Ø© ØªØ¯Ø±Ù‘Ø¨Ùƒ Ø¹Ù„Ù‰: if / elif / AND / OR / Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ù…ØªØ¯Ø§Ø®Ù„Ø©.
    </p>
  </header>

  <main>
    <div class="grid">
      <!-- Game -->
      <section class="card">
        <div class="row">
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
            <label class="muted" for="stageSelect" style="font-size:13px">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø©:</label>
            <select id="stageSelect" class="select" aria-label="Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø©">
              <option value="1">Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1 (Ø´Ø±Ø· Ø¨Ø³ÙŠØ·)</option>
              <option value="2">Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2 (elif)</option>
              <option value="3">Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3 (Ù…Ù‚Ø§Ø±Ù†Ø© Ø±Ù‚Ù…ÙŠØ©)</option>
              <option value="4">Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4 (AND)</option>
              <option value="5">Ø§Ù„Ù…Ø±Ø­Ù„Ø© 5 (OR)</option>
              <option value="6">Ø§Ù„Ù…Ø±Ø­Ù„Ø© 6 (Ù†Ø·Ø§Ù‚ Ø³Ø±Ø¹Ø©)</option>
              <option value="7">Ø§Ù„Ù…Ø±Ø­Ù„Ø© 7 (Nested)</option>
              <option value="8">Ø§Ù„Ù…Ø±Ø­Ù„Ø© 8 (Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ)</option>
            </select>

            <button id="newBtn" class="btnSecondary" type="button">ğŸ”„ Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
          </div>

          <div class="pill" title="ÙˆØ¶Ø¹ Ø§Ù„ØµÙ">
            ğŸ§‘â€ğŸ« <strong>Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù…Ø¯Ø±Ø³Ø©</strong> <span class="muted">â€” Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª</span>
          </div>
        </div>

        <div class="scenario">
          <div class="light" aria-label="Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <div class="bulbs">
              <div class="bulb" id="bulbRed"></div>
              <div class="bulb" id="bulbYellow"></div>
              <div class="bulb" id="bulbGreen"></div>
            </div>
          </div>

          <div class="facts">
            <h2>ğŸ§¾ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø©</h2>
            <ul>
              <li>Ù„ÙˆÙ† Ø§Ù„Ø¥Ø´Ø§Ø±Ø©: <strong id="factColor">â€”</strong></li>
              <li>Ø³Ø±Ø¹Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©: <strong id="factSpeed">â€”</strong> ÙƒÙ…/Ø³</li>
              <li>ÙŠÙˆØ¬Ø¯ Ø¥Ø³Ø¹Ø§ÙØŸ <strong id="factAmb">â€”</strong></li>
              <li>ÙŠÙˆØ¬Ø¯ Ø´Ø±Ø·Ø©ØŸ <strong id="factPolice">â€”</strong></li>
            </ul>
            <div class="actions" role="group" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø±Ø§Ø±">
              <button class="btnStop"   id="btnStop"   type="button">ğŸ›‘ ØªÙˆÙ‚Ù</button>
              <button class="btnSlow"   id="btnSlow"   type="button">âš ï¸ Ø§Ù‡Ø¯Ø£</button>
              <button class="btnGo"     id="btnGo"     type="button">âœ… Ø§Ù…Ø´Ù</button>
              <button class="btnTicket" id="btnTicket" type="button">ğŸ§¾ Ù…Ø®Ø§Ù„ÙØ©</button>
            </div>

            <div class="footerRow">
              <div class="hint" id="hintText">ğŸ’¡ ØªÙ„Ù…ÙŠØ­: Ø§Ù‚Ø±Ø£ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ†.</div>
              <button class="btnSecondary" id="resetBtn" type="button">ğŸ§¹ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Sidebar -->
      <aside class="card sidebar">
        <h3>ğŸ“š Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
        <div class="kpis">
          <div class="kpi">
            <div class="label">Ø§Ù„Ù…Ø±Ø­Ù„Ø©</div>
            <div class="value" id="kpiStage">1</div>
          </div>
          <div class="kpi">
            <div class="label">Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø©</div>
            <div class="value" id="kpiBest">0</div>
          </div>
        </div>

        <div class="rules" id="rulesBox"></div>

        <div class="rules">
          <strong>ğŸ¯ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù„Ø¹Ø¨:</strong>
          <div class="muted">
            Ø§Ø¶ØºØ· Ø£Ø­Ø¯ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø±Ø¨Ø¹Ø© (ØªÙˆÙ‚Ù/Ø§Ù‡Ø¯Ø£/Ø§Ù…Ø´Ù/Ù…Ø®Ø§Ù„ÙØ©). Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ø®ØªÙŠØ§Ø±Ùƒ ØµØ­ÙŠØ­Ù‹Ø§ ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø·ØŒ
            ÙˆØ¥Ø°Ø§ Ø£Ø®Ø·Ø£Øª Ø³ØªØ¸Ù‡Ø± Ù„Ùƒ Ø±Ø³Ø§Ù„Ø© ØªÙˆØ¶Ø­ Ø§Ù„Ø³Ø¨Ø¨.
          </div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Modal -->
  <div class="modalWrap" id="modalWrap" role="dialog" aria-modal="true" aria-label="Ù†ØªÙŠØ¬Ø©">
    <div class="modal">
      <div class="modalHeader">
        <div id="modalBadge" class="badge ok">ØµØ­ÙŠØ­ âœ…</div>
        <button class="btnSecondary" id="closeModalBtn" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <p id="modalText">â€”</p>
      <div class="modalActions">
        <button class="btnSecondary" id="nextBtn" type="button">Ø§Ù„ØªØ§Ù„ÙŠ âœ</button>
      </div>
    </div>
  </div>

  <script>
    // ---------------------------
    //  Helpers
    // ---------------------------
    const $ = (id) => document.getElementById(id);
    const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const chance = (p) => Math.random() < p; // p between 0..1
    const boolAr = (b) => b ? "Ù†Ø¹Ù…" : "Ù„Ø§";

    const bulbs = {
      red: $("bulbRed"),
      yellow: $("bulbYellow"),
      green: $("bulbGreen"),
    };

    function setLight(color){
      bulbs.red.className = "bulb" + (color==="Ø£Ø­Ù…Ø±" ? " on red" : "");
      bulbs.yellow.className = "bulb" + (color==="Ø£ØµÙØ±" ? " on yellow" : "");
      bulbs.green.className = "bulb" + (color==="Ø£Ø®Ø¶Ø±" ? " on green" : "");
    }

    // ---------------------------
    //  Game State
    // ---------------------------
    const state = {
      stage: 1,
      round: 1,
      score: 0,
      best: 0,
      scenario: null, // {color, speed, ambulance, police}
    };

    const rulesText = {
      1: `Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1 (Ø´Ø±Ø· Ø¨Ø³ÙŠØ·):
      - Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¥Ø´Ø§Ø±Ø© <strong>Ø£Ø­Ù…Ø±</strong> âœ <strong>ØªÙˆÙ‚Ù</strong>
      - ØºÙŠØ± Ø°Ù„Ùƒ âœ <strong>Ø§Ù…Ø´Ù</strong>`,

      2: `Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2 (elif):
      - Ø£Ø­Ù…Ø± âœ <strong>ØªÙˆÙ‚Ù</strong>
      - Ø£ØµÙØ± âœ <strong>Ø§Ù‡Ø¯Ø£</strong>
      - Ø£Ø®Ø¶Ø± âœ <strong>Ø§Ù…Ø´Ù</strong>`,

      3: `Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3 (Ù…Ù‚Ø§Ø±Ù†Ø© Ø±Ù‚Ù…ÙŠØ©):
      - Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø³Ø±Ø¹Ø© â‰¤ 60 âœ <strong>Ø§Ù…Ø´Ù</strong>
      - Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø³Ø±Ø¹Ø© > 60 âœ <strong>Ù…Ø®Ø§Ù„ÙØ©</strong>`,

      4: `Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4 (AND):
      - Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¥Ø´Ø§Ø±Ø© <strong>Ø®Ø¶Ø±Ø§Ø¡</strong> AND <strong>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±Ø·Ø©</strong> âœ <strong>Ø§Ù…Ø´Ù</strong>
      - ØºÙŠØ± Ø°Ù„Ùƒ âœ <strong>ØªÙˆÙ‚Ù</strong>`,

      5: `Ø§Ù„Ù…Ø±Ø­Ù„Ø© 5 (OR):
      - Ø¥Ø°Ø§ ÙŠÙˆØ¬Ø¯ <strong>Ø¥Ø³Ø¹Ø§Ù</strong> OR Ø§Ù„Ø¥Ø´Ø§Ø±Ø© <strong>Ø®Ø¶Ø±Ø§Ø¡</strong> âœ <strong>Ø§Ù…Ø´Ù</strong>
      - ØºÙŠØ± Ø°Ù„Ùƒ âœ <strong>ØªÙˆÙ‚Ù</strong>`,

      6: `Ø§Ù„Ù…Ø±Ø­Ù„Ø© 6 (Ù†Ø·Ø§Ù‚ Ø³Ø±Ø¹Ø©):
      - Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø³Ø±Ø¹Ø© Ø¨ÙŠÙ† 40 Ùˆ 60 (Ø´Ø§Ù…Ù„Ø©) âœ <strong>Ø§Ù…Ø´Ù</strong>
      - ØºÙŠØ± Ø°Ù„Ùƒ âœ <strong>Ø§Ù‡Ø¯Ø£</strong>`,

      7: `Ø§Ù„Ù…Ø±Ø­Ù„Ø© 7 (Nested Ø´Ø±ÙˆØ· Ù…ØªØ¯Ø§Ø®Ù„Ø©):
      - Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¥Ø´Ø§Ø±Ø© <strong>Ø®Ø¶Ø±Ø§Ø¡</strong>:
        - Ø¥Ø°Ø§ Ø§Ù„Ø³Ø±Ø¹Ø© â‰¤ 60 âœ <strong>Ø§Ù…Ø´Ù</strong>
        - ØºÙŠØ± Ø°Ù„Ùƒ âœ <strong>Ù…Ø®Ø§Ù„ÙØ©</strong>
      - ØºÙŠØ± Ø°Ù„Ùƒ âœ <strong>ØªÙˆÙ‚Ù</strong>`,

      8: `Ø§Ù„Ù…Ø±Ø­Ù„Ø© 8 (Ø§Ù„ØªØ­Ø¯Ù‘ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ):
      - Ø¥Ø°Ø§ ÙŠÙˆØ¬Ø¯ <strong>Ø¥Ø³Ø¹Ø§Ù</strong> âœ <strong>Ø§Ù…Ø´Ù</strong> (Ø£ÙˆÙ„ÙˆÙŠØ©)
      - ÙˆØ¥Ù„Ø§ Ø¥Ø°Ø§ (Ø®Ø¶Ø±Ø§Ø¡ AND Ø§Ù„Ø³Ø±Ø¹Ø© â‰¤ 60 AND Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±Ø·Ø©) âœ <strong>Ø§Ù…Ø´Ù</strong>
      - ÙˆØ¥Ù„Ø§ Ø¥Ø°Ø§ (Ø£ØµÙØ± AND Ø§Ù„Ø³Ø±Ø¹Ø© Ø¨ÙŠÙ† 30 Ùˆ 50) âœ <strong>Ø§Ù‡Ø¯Ø£</strong>
      - ÙˆØ¥Ù„Ø§ Ø¥Ø°Ø§ (Ø§Ù„Ø³Ø±Ø¹Ø© > 70) âœ <strong>Ù…Ø®Ø§Ù„ÙØ©</strong>
      - ØºÙŠØ± Ø°Ù„Ùƒ âœ <strong>ØªÙˆÙ‚Ù</strong>`
    };

    function computeCorrectDecision(stage, s){
      const { color, speed, ambulance, police } = s;

      if(stage === 1){
        return (color === "Ø£Ø­Ù…Ø±") ? "ØªÙˆÙ‚Ù" : "Ø§Ù…Ø´Ù";
      }
      if(stage === 2){
        if(color === "Ø£Ø­Ù…Ø±") return "ØªÙˆÙ‚Ù";
        if(color === "Ø£ØµÙØ±") return "Ø§Ù‡Ø¯Ø£";
        return "Ø§Ù…Ø´Ù";
      }
      if(stage === 3){
        return (speed <= 60) ? "Ø§Ù…Ø´Ù" : "Ù…Ø®Ø§Ù„ÙØ©";
      }
      if(stage === 4){
        return (color === "Ø£Ø®Ø¶Ø±" && !police) ? "Ø§Ù…Ø´Ù" : "ØªÙˆÙ‚Ù";
      }
      if(stage === 5){
        return (ambulance || color === "Ø£Ø®Ø¶Ø±") ? "Ø§Ù…Ø´Ù" : "ØªÙˆÙ‚Ù";
      }
      if(stage === 6){
        return (speed >= 40 && speed <= 60) ? "Ø§Ù…Ø´Ù" : "Ø§Ù‡Ø¯Ø£";
      }
      if(stage === 7){
        if(color === "Ø£Ø®Ø¶Ø±"){
          return (speed <= 60) ? "Ø§Ù…Ø´Ù" : "Ù…Ø®Ø§Ù„ÙØ©";
        }
        return "ØªÙˆÙ‚Ù";
      }
      // stage 8
      if(ambulance){
        return "Ø§Ù…Ø´Ù";
      } else if(color === "Ø£Ø®Ø¶Ø±" && speed <= 60 && !police){
        return "Ø§Ù…Ø´Ù";
      } else if(color === "Ø£ØµÙØ±" && speed >= 30 && speed <= 50){
        return "Ø§Ù‡Ø¯Ø£";
      } else if(speed > 70){
        return "Ù…Ø®Ø§Ù„ÙØ©";
      } else {
        return "ØªÙˆÙ‚Ù";
      }
    }

    function why(stage, s, correct){
      const { color, speed, ambulance, police } = s;
      const c = correct;

      // ØªÙØ³ÙŠØ± Ø¨Ø³ÙŠØ· Ø­Ø³Ø¨ Ø§Ù„Ù…Ø±Ø­Ù„Ø©
      if(stage === 1){
        return (color==="Ø£Ø­Ù…Ø±")
          ? "Ù„Ø£Ù† Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø­Ù…Ø±Ø§Ø¡ØŒ ÙˆØ§Ù„Ù‚Ø§Ø¹Ø¯Ø© ØªÙ‚ÙˆÙ„: Ø£Ø­Ù…Ø± âœ ØªÙˆÙ‚Ù."
          : "Ù„Ø£Ù†Ù‡Ø§ Ù„ÙŠØ³Øª Ø­Ù…Ø±Ø§Ø¡ØŒ ÙˆØ§Ù„Ù‚Ø§Ø¹Ø¯Ø© ØªÙ‚ÙˆÙ„: ØºÙŠØ± Ø°Ù„Ùƒ âœ Ø§Ù…Ø´Ù.";
      }
      if(stage === 2){
        return `Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ù‡Ù†Ø§ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù„ÙˆÙ† Ø§Ù„Ø¥Ø´Ø§Ø±Ø©: Ø£Ø­Ù…Ø±=ØªÙˆÙ‚ÙØŒ Ø£ØµÙØ±=Ø§Ù‡Ø¯Ø£ØŒ Ø£Ø®Ø¶Ø±=Ø§Ù…Ø´Ù.`;
      }
      if(stage === 3){
        return (speed <= 60)
          ? `Ø§Ù„Ø³Ø±Ø¹Ø© ${speed} â‰¤ 60ØŒ Ø¥Ø°Ù† Ø§Ù„Ù‚Ø±Ø§Ø±: Ø§Ù…Ø´Ù.`
          : `Ø§Ù„Ø³Ø±Ø¹Ø© ${speed} > 60ØŒ Ø¥Ø°Ù† Ø§Ù„Ù‚Ø±Ø§Ø±: Ù…Ø®Ø§Ù„ÙØ©.`;
      }
      if(stage === 4){
        return (color==="Ø£Ø®Ø¶Ø±" && !police)
          ? "Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø®Ø¶Ø±Ø§Ø¡ ÙˆÙ„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±Ø·Ø©ØŒ (AND) ØªØ­Ù‚Ù‚ âœ Ø§Ù…Ø´Ù."
          : "Ø´Ø±Ø· (AND) Ù„Ù… ÙŠØªØ­Ù‚Ù‚ (Ø¥Ù…Ø§ Ù„ÙŠØ³Øª Ø®Ø¶Ø±Ø§Ø¡ Ø£Ùˆ ØªÙˆØ¬Ø¯ Ø´Ø±Ø·Ø©) âœ ØªÙˆÙ‚Ù.";
      }
      if(stage === 5){
        return (s.ambulance || color==="Ø£Ø®Ø¶Ø±")
          ? "ÙŠÙˆØ¬Ø¯ Ø¥Ø³Ø¹Ø§Ù Ø£Ùˆ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø®Ø¶Ø±Ø§Ø¡ØŒ Ø´Ø±Ø· (OR) ØªØ­Ù‚Ù‚ âœ Ø§Ù…Ø´Ù."
          : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø³Ø¹Ø§Ù ÙˆØ§Ù„Ø¥Ø´Ø§Ø±Ø© Ù„ÙŠØ³Øª Ø®Ø¶Ø±Ø§Ø¡ØŒ Ø´Ø±Ø· (OR) Ù„Ù… ÙŠØªØ­Ù‚Ù‚ âœ ØªÙˆÙ‚Ù.";
      }
      if(stage === 6){
        return (speed>=40 && speed<=60)
          ? `Ø§Ù„Ø³Ø±Ø¹Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚ 40..60 âœ Ø§Ù…Ø´Ù.`
          : `Ø§Ù„Ø³Ø±Ø¹Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚ 40..60 âœ Ø§Ù‡Ø¯Ø£.`;
      }
      if(stage === 7){
        return (color==="Ø£Ø®Ø¶Ø±")
          ? (speed<=60 ? "Ø¥Ø´Ø§Ø±Ø© Ø®Ø¶Ø±Ø§Ø¡ Ø«Ù… Ø³Ø±Ø¹Ø© â‰¤ 60 âœ Ø§Ù…Ø´Ù." : "Ø¥Ø´Ø§Ø±Ø© Ø®Ø¶Ø±Ø§Ø¡ Ù„ÙƒÙ† Ø³Ø±Ø¹Ø© > 60 âœ Ù…Ø®Ø§Ù„ÙØ©.")
          : "Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ù„ÙŠØ³Øª Ø®Ø¶Ø±Ø§Ø¡ âœ ØªÙˆÙ‚Ù.";
      }
      // stage 8
      if(ambulance) return "Ù„Ø£Ù† Ù‡Ù†Ø§Ùƒ Ø¥Ø³Ø¹Ø§ÙØŒ Ù„Ù‡ Ø£ÙˆÙ„ÙˆÙŠØ©: Ø§Ù…Ø´Ù.";
      if(color==="Ø£Ø®Ø¶Ø±" && speed<=60 && !police) return "Ø®Ø¶Ø±Ø§Ø¡ + Ø³Ø±Ø¹Ø© â‰¤ 60 + Ù„Ø§ Ø´Ø±Ø·Ø© (AND) âœ Ø§Ù…Ø´Ù.";
      if(color==="Ø£ØµÙØ±" && speed>=30 && speed<=50) return "Ø£ØµÙØ± + Ø³Ø±Ø¹Ø© 30..50 âœ Ø§Ù‡Ø¯Ø£.";
      if(speed>70) return "Ø§Ù„Ø³Ø±Ø¹Ø© > 70 âœ Ù…Ø®Ø§Ù„ÙØ©.";
      return "Ù„Ù… ÙŠØªØ­Ù‚Ù‚ Ø£ÙŠ Ø´Ø±Ø· Ø®Ø§ØµØŒ Ø¥Ø°Ù† Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© âœ ØªÙˆÙ‚Ù.";
    }

    function generateScenario(stage){
      // Ù„ØªÙƒÙˆÙ† Ø§Ù„Ø­Ø§Ù„Ø§Øª Ù…ÙÙŠØ¯Ø© ØªØ¹Ù„ÙŠÙ…ÙŠØ§Ù‹ØŒ Ù†ØªØ­ÙƒÙ… Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø¨Ø§Ù„ØªÙˆØ²ÙŠØ¹
      const colors = ["Ø£Ø­Ù…Ø±","Ø£ØµÙØ±","Ø£Ø®Ø¶Ø±"];
      const color = colors[randInt(0,2)];

      // Ø§Ù„Ø³Ø±Ø¹Ø©: ÙÙŠ Ù…Ø±Ø§Ø­Ù„ 3/6/7/8 Ù†Ø­ØªØ§Ø¬ Ø£Ø±Ù‚Ø§Ù… Ù…ØªÙ†ÙˆÙ‘Ø¹Ø©
      let speed;
      if([3,6,7,8].includes(stage)){
        // Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ù…ØªÙ†ÙˆÙ‘Ø¹Ø© ØªØ´Ù…Ù„ Ø§Ù„Ø­Ø¯ÙˆØ¯
        const picks = [0, 20, 30, 39, 40, 50, 60, 61, 70, 71, 90, 100];
        speed = picks[randInt(0, picks.length-1)];
      } else {
        speed = randInt(0, 100);
      }

      // Ø¥Ø³Ø¹Ø§Ù/Ø´Ø±Ø·Ø©: Ù…ÙÙŠØ¯Ø© ÙÙŠ 4/5/8
      const ambulance = chance(stage>=5 ? 0.35 : 0.20);
      const police = chance(stage>=4 ? 0.35 : 0.20);

      return { color, speed, ambulance, police };
    }

    function render(){
      $("stageSelect").value = String(state.stage);
      $("stageLabel").textContent = `Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${state.stage}`;
      $("roundLabel").textContent = `Ø§Ù„Ø¬ÙˆÙ„Ø© ${state.round}`;
      $("scoreLabel").textContent = String(state.score);

      $("kpiStage").textContent = String(state.stage);
      $("kpiBest").textContent = String(state.best);

      $("rulesBox").innerHTML = rulesText[state.stage];

      const s = state.scenario;
      $("factColor").textContent = s.color;
      $("factSpeed").textContent = String(s.speed);
      $("factAmb").textContent = boolAr(s.ambulance);
      $("factPolice").textContent = boolAr(s.police);

      setLight(s.color);

      // ØªÙ„Ù…ÙŠØ­ Ø¨Ø³ÙŠØ· Ø­Ø³Ø¨ Ø§Ù„Ù…Ø±Ø­Ù„Ø©
      const hintMap = {
        1: "Ø¬Ø±Ù‘Ø¨ ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ø¥Ù„Ù‰ if/else Ø¨Ø³ÙŠØ·.",
        2: "Ù‡Ù†Ø§ Ù†Ø³ØªØ®Ø¯Ù… if Ø«Ù… elif Ø«Ù… else.",
        3: "Ø±ÙƒØ² Ø¹Ù„Ù‰ Ù…Ù‚Ø§Ø±Ù†Ø© Ø±Ù‚Ù…ÙŠØ©: <= Ùˆ >.",
        4: "Ø§Ù†ØªØ¨Ù‡ Ù„Ø´Ø±Ø· AND (Ù„Ø§Ø²Ù… Ø§Ù„Ø´Ø±Ø·Ø§Ù† Ù…Ø¹Ù‹Ø§).",
        5: "Ø§Ù†ØªØ¨Ù‡ Ù„Ø´Ø±Ø· OR (ÙŠÙƒÙÙŠ Ø´Ø±Ø· ÙˆØ§Ø­Ø¯).",
        6: "Ù‡Ù†Ø§ Ù†Ø³ØªØ®Ø¯Ù… Ù†Ø·Ø§Ù‚: 40 <= speed <= 60.",
        7: "Nested: Ø´Ø±Ø· Ø¯Ø§Ø®Ù„ Ø´Ø±Ø·.",
        8: "Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© (Ø§Ù„Ø¥Ø³Ø¹Ø§Ù) Ø«Ù… Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø´Ø±ÙˆØ·."
      };
      $("hintText").textContent = "ğŸ’¡ ØªÙ„Ù…ÙŠØ­: " + hintMap[state.stage];
    }

    function newRound(keepStage=false){
      if(!keepStage) state.round += 1;
      state.scenario = generateScenario(state.stage);
      render();
    }

    // ---------------------------
    //  Modal
    // ---------------------------
    function showModal(isOk, text){
      const badge = $("modalBadge");
      badge.className = "badge " + (isOk ? "ok" : "bad");
      badge.textContent = isOk ? "ØµØ­ÙŠØ­ âœ…" : "Ø®Ø·Ø£ âŒ";
      $("modalText").textContent = text;
      $("modalWrap").style.display = "flex";
    }
    function closeModal(){
      $("modalWrap").style.display = "none";
    }

    // ---------------------------
    //  Game Logic: Answer
    // ---------------------------
    function answer(choice){
      const s = state.scenario;
      const correct = computeCorrectDecision(state.stage, s);

      if(choice === correct){
        // Ù†Ù‚Ø§Ø·: ÙƒÙ„Ù…Ø§ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø£Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø· Ø£ÙƒØ«Ø±
        const gained = 5 + (state.stage-1) * 2;
        state.score += gained;
        if(state.score > state.best) state.best = state.score;

        const explain = why(state.stage, s, correct);
        showModal(true, `âœ… Ù…Ù…ØªØ§Ø²! Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­ Ù‡Ùˆ: ${correct}. \n\nØ§Ù„Ø³Ø¨Ø¨: ${explain}\n\n+${gained} Ù†Ù‚Ø·Ø©`);
        // Ø§Ù†ØªÙ‚Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù…Ø±Ø­Ù„Ø© Ø£Ø¹Ù„Ù‰ Ø¥Ø°Ø§ Ù†Ø¬Ø­ Ù…Ø±ØªÙŠÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø±Ø­Ù„Ø© (ØªØ¨Ø³ÙŠØ·)
        state._winStreak = (state._winStreak || 0) + 1;
        if(state._winStreak >= 2 && state.stage < 8){
          state.stage += 1;
          state._winStreak = 0;
          $("nextBtn").textContent = "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© âœ";
        } else {
          $("nextBtn").textContent = "Ø§Ù„ØªØ§Ù„ÙŠ âœ";
        }
      } else {
        // Ø¹Ù‚ÙˆØ¨Ø© Ø¨Ø³ÙŠØ·Ø©
        state.score = Math.max(0, state.score - 3);
        const explain = why(state.stage, s, correct);
        showModal(false, `âŒ Ø§Ø®ØªÙŠØ§Ø±Ùƒ: ${choice}\nâœ… Ø§Ù„ØµØ­ÙŠØ­: ${correct}\n\nØ§Ù„Ø³Ø¨Ø¨: ${explain}\n\n-3 Ù†Ù‚Ø§Ø· (Ù„Ù„ØªØ¹Ù„Ù‘Ù… ğŸ˜‰)`);
        state._winStreak = 0;
        $("nextBtn").textContent = "Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© âœ";
      }

      render();
    }

    // ---------------------------
    //  Events
    // ---------------------------
    $("btnStop").addEventListener("click", () => answer("ØªÙˆÙ‚Ù"));
    $("btnSlow").addEventListener("click", () => answer("Ø§Ù‡Ø¯Ø£"));
    $("btnGo").addEventListener("click", () => answer("Ø§Ù…Ø´Ù"));
    $("btnTicket").addEventListener("click", () => answer("Ù…Ø®Ø§Ù„ÙØ©"));

    $("newBtn").addEventListener("click", () => newRound(true));
    $("resetBtn").addEventListener("click", () => {
      state.stage = 1;
      state.round = 1;
      state.score = 0;
      state._winStreak = 0;
      state.scenario = generateScenario(state.stage);
      render();
      showModal(true, "ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø· âœ… Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1.");
    });

    $("stageSelect").addEventListener("change", (e) => {
      state.stage = parseInt(e.target.value, 10);
      state._winStreak = 0;
      state.scenario = generateScenario(state.stage);
      render();
    });

    $("closeModalBtn").addEventListener("click", closeModal);
    $("modalWrap").addEventListener("click", (e) => {
      if(e.target === $("modalWrap")) closeModal();
    });
    $("nextBtn").addEventListener("click", () => {
      closeModal();
      // Ø¨Ø¹Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†ØªÙŠØ¬Ø©: Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©
      state.round += 1;
      state.scenario = generateScenario(state.stage);
      render();
    });

    // Start
    state.scenario = generateScenario(state.stage);
    render();
  </script>
</body>
</html>
